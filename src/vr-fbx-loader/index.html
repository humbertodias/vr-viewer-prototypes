<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>FBX Loader</title>

    <link rel="icon" type="image/x-icon" href="favicon.png">

    <!-- three -->
    <script src="../three.js"></script>

    <!-- fbx loader -->
    <script src="js/fbx/OrbitControls.js"></script>
    <script src="js/fbx/FBXLoader.js"></script>
    <script src="js/fbx/Detector.js"></script>
    <script src="js/fbx/stats.js"></script>

    <!-- stereo -->
    <script src="js/stereo/StereoEffect.js"></script>
    <script src="js/stereo/FirstPersonControls.js"></script>
    <script src="js/stereo/DeviceOrientationControls.js"></script>
    <script src="js/stereo/OrbitControls.js"></script>

    <style>

body {
  margin: 0px;
  overflow: hidden;
}

#container {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

    </style>

</head>

<body>

    <div id="container"></div>
        <script>
            
            // http://threejs.org/examples/webgl_loader_fbx.html
            // https://github.com/charliegerard/Threejs-VR
            
           if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

            var container, stats, controls;
            var camera, scene, renderer;

            var effect;

            var clock = new THREE.Clock();

            var mixers = [];

            init();
            animate();

            function init() {

              scene = new THREE.Scene();
              scene.fog   = new THREE.FogExp2( 0xd0e0f0, 0.0025 );

              renderer = new THREE.WebGLRenderer();
              renderer.setSize( window.innerWidth, window.innerHeight );
              element = renderer.domElement;
              container = document.getElementById('container');
              container.appendChild(element);


              camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.3, 10000);
              camera.position.set(-20, 10, 0);
              scene.add(camera);

                effect = new THREE.StereoEffect(renderer);              

                var light = new THREE.HemisphereLight(0xfffff0, 0x101020, 1.5);
                light.position.set( 0.75, 1, 0.25 );
                scene.add(light);

 
            // grid
            var gridHelper = new THREE.GridHelper( 24, 1 );
            gridHelper.setColors( 0x303030, 0x303030 );
            gridHelper.position.set( 0, - 0.04, 0 );
            scene.add( gridHelper );
               
                
            var ambient = new THREE.AmbientLight( 0x444444 );
             scene.add( ambient );

 
                // stats
             stats = new Stats();
             container.appendChild( stats.dom );

            controls    = new THREE.FirstPersonControls( camera );
            controls.movementSpeed  = 100;
            controls.lookSpeed  = 2;
            controls.lookVertical   = true;


            function setOrientationControls(e) {
                if (!e.alpha) {
                  return;
                }

                controls = new THREE.DeviceOrientationControls(camera, true);
                controls.connect();
                controls.update();

                element.addEventListener('click', fullscreen, false);

                window.removeEventListener('deviceorientation', setOrientationControls, true);
            }
            window.addEventListener('deviceorientation', setOrientationControls, true);


            window.addEventListener('resize', resize, false);
            setTimeout(resize, 1);
          }


        function resize() {
          var width = container.offsetWidth;
          var height = container.offsetHeight;

          camera.aspect = width / height;
          camera.updateProjectionMatrix();

          renderer.setSize(width, height);
          effect.setSize(width, height);
        }

        function update(dt) {
          resize();

          camera.updateProjectionMatrix();

          controls.update(dt);
        }        

        function render(dt) {
          effect.render(scene, camera);
        }

        function animate(t) {
          requestAnimationFrame(animate);

          if ( mixers.length > 0 ) {
            for ( var i = 0; i < mixers.length; i ++ ) {
                mixers[ i ].update( clock.getDelta() );
            }
          }

             stats.update();

          update(clock.getDelta());
          render(clock.getDelta());
        }

        function fullscreen() {
          if (container.requestFullscreen) {
            container.requestFullscreen();
          } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
          } else if (container.mozRequestFullScreen) {
            container.mozRequestFullScreen();
          } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
          }
        }



                // model
                var manager = new THREE.LoadingManager();
                manager.onProgress = function( item, loaded, total ) {
                    console.log( item, loaded, total );
                };

                var onProgress = function( xhr ) {

                    if ( xhr.lengthComputable ) {

                        var percentComplete = xhr.loaded / xhr.total * 100;
                        var val = Math.round( percentComplete, 2 ) + '% downloaded';
                        console.log( val );
                    }

                };

                var onError = function( xhr ) {};
                var loadCallBack = function( object ) {

                    object.traverse( function( child ) {

                        if ( child instanceof THREE.Mesh ) {
                            // pass
                        }

                        if ( child instanceof THREE.SkinnedMesh ) {

                            if ( child.geometry.animations !== undefined || child.geometry.morphAnimations !== undefined ) {

                                child.mixer = new THREE.AnimationMixer( child );
                                mixers.push( child.mixer );

                                var action = child.mixer.clipAction( child.geometry.animations[ 0 ] );
                                action.play();

                            }

                        }

                    } );

                    scene.add( object );
                };
                
                // FBX
                var loader = new THREE.FBXLoader( manager );
                var fbx_path = "models/fbx/Handgun_Game_Blender Gamer Engine.fbx";
                fbx_path = 'models/fbx/xsi_man.fbx';

                var baseURL = window.location.protocol + "//" + window.location.host + window.location.pathname;

                fbx_path = baseURL + 'models/fbx/xsi_man_skinning.fbx';
                // fbx_path = "http://cors.io/?u=https://github.com/mrdoob/three.js/blob/master/examples/models/fbx/xsi_man_skinning.fbx?raw=true"
                // descomente para perguntar a url dinamicamente
                // fbx_path = prompt('FBX URL', fbx_path);
                loader.load( fbx_path, loadCallBack, onProgress, onError );
            
        </script>

</body>

</html>